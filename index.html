<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師退休薪資精算系統 (進階版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .input-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .input-roc { display: flex; align-items: center; gap: 0.5rem; }
        .input-roc input { width: 100%; border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.375rem; }
        .input-roc span { color: #6b7280; font-size: 0.875rem; white-space: nowrap; }
        .section-card { background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .btn-add { background-color: #eff6ff; color: #2563eb; border: 1px dashed #bfdbfe; transition: all 0.2s; }
        .btn-add:hover { background-color: #dbeafe; border-color: #3b82f6; }
        .tag-badge { font-size: 0.75rem; padding: 0.1rem 0.4rem; border-radius: 9999px; white-space: nowrap; }
        
        /* Table styles */
        .table-container { overflow-x: auto; max-height: 600px; }
        thead th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        tr.is-leave { background-color: #fef2f2; color: #991b1b; }
        tr.is-promo-fail { background-color: #fffbeb; color: #92400e; }
        tr.is-retired { background-color: #f0fdf4; color: #166534; font-weight: bold; border-left: 4px solid #22c55e; }

        /* Modal Styles */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        
        /* Fade in for dynamic elements */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-calculator text-blue-600 mr-2"></i>教師退休生涯精算系統 (118年1月1日後退休者適用)
            </h1>
            <p class="text-gray-500 mb-2">支援學年度制、改敘、留停、考績、公保及展期/減額月退試算</p>
            <p class="text-gray-500 mb-2">薪級資料不會自動更新，資料以114.1.1調薪後為準</p>
            <button onclick="toggleModal(true)" class="text-blue-600 hover:text-blue-800 underline text-sm font-medium transition-colors">
                <i class="fas fa-info-circle mr-1"></i>查看計算公式說明
            </button>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
            
            <!-- 左側設置區 (佔 4/12) -->
            <div class="xl:col-span-4 space-y-6">
                
                <!-- 1. 基本資料 -->
                <div class="section-card border-l-4 border-blue-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-user-circle mr-2 text-blue-500"></i>基本資料設定
                    </h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <label>初任學歷 (起敘點)</label>
                            <select id="degree" class="w-full border p-2 rounded bg-gray-50 focus:ring-2 focus:ring-blue-500">
                                <option value="bachelor" selected>大學 (起敘26級 / 頂625)</option>
                                <option value="master">碩士 (起敘21級 / 頂650)</option>
                                <option value="phd">博士 (起敘16級 / 頂680)</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>出生日期 (民國)</label>
                            <div class="flex gap-2">
                                <input type="number" id="birthY" placeholder="年" class="border p-2 rounded w-20" value="70">
                                <input type="number" id="birthM" placeholder="月" class="border p-2 rounded w-16" value="1">
                                <input type="number" id="birthD" placeholder="日" class="border p-2 rounded w-16" value="1">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>初任教職日期 (民國)</label>
                            <div class="flex gap-2">
                                <input type="number" id="startY" placeholder="年" class="border p-2 rounded w-20" value="95">
                                <input type="number" id="startM" placeholder="月" class="border p-2 rounded w-16" value="8">
                                <input type="number" id="startD" placeholder="日" class="border p-2 rounded w-16" value="1">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>預計退休日期 (民國)</label>
                            <div class="flex gap-2">
                                <input type="number" id="retireY" placeholder="年" class="border p-2 rounded w-20" value="125">
                                <input type="number" id="retireM" placeholder="月" class="border p-2 rounded w-16" value="8">
                                <input type="number" id="retireD" placeholder="日" class="border p-2 rounded w-16" value="1">
                            </div>
                        </div>

                        <!-- 隱藏的提早退休選項區塊，計算後若年齡<58才顯示 -->
                        <div id="earlyRetireSection" class="hidden border-t pt-4 mt-2 fade-in">
                            <label class="block text-sm font-bold text-red-600 mb-2">
                                <i class="fas fa-exclamation-triangle mr-1"></i>未滿 58 歲退休選項
                            </label>
                            <div class="flex flex-col gap-2">
                                <label class="inline-flex items-center p-2 border rounded cursor-pointer bg-white hover:bg-gray-50">
                                    <input type="radio" name="earlyOption" value="deferred" class="form-radio text-blue-600" checked onchange="calculate()">
                                    <div class="ml-2">
                                        <span class="block text-sm font-bold text-gray-800">展期月退休金</span>
                                        <span class="block text-xs text-gray-500">延後至58歲起領取全額</span>
                                    </div>
                                </label>
                                <label class="inline-flex items-center p-2 border rounded cursor-pointer bg-white hover:bg-gray-50">
                                    <input type="radio" name="earlyOption" value="reduced" class="form-radio text-blue-600" onchange="calculate()">
                                    <div class="ml-2">
                                        <span class="block text-sm font-bold text-gray-800">減額月退休金</span>
                                        <span class="block text-xs text-gray-500">即刻領取，每早1年減4%</span>
                                    </div>
                                </label>
                            </div>
                            <div id="earlyRetireMsg" class="text-xs text-red-500 mt-2 font-medium"></div>
                        </div>
                    </div>
                </div>

                <!-- 2. 特殊狀況設定 (改敘、留停、考績) -->
                <div class="section-card border-l-4 border-purple-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-calendar-check mr-2 text-purple-500"></i>特殊歷程設定
                    </h2>

                    <!-- 改敘 -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-gray-700">學歷改敘 / 提敘</label>
                            <button onclick="addEventRow('reeval')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200"><i class="fas fa-plus"></i> 新增</button>
                        </div>
                        <div id="reevalList" class="space-y-2 text-sm">
                            <!-- JS 動態插入 -->
                        </div>
                    </div>

                    <!-- 留職停薪 -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-gray-700">留職停薪 (扣除年資)</label>
                            <button onclick="addEventRow('leave')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200"><i class="fas fa-plus"></i> 新增</button>
                        </div>
                        <div id="leaveList" class="space-y-2 text-sm">
                            <!-- JS 動態插入 -->
                        </div>
                    </div>

                    <!-- 考績乙丙 -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-gray-700">考績丙等 (不晉級)</label>
                            <button onclick="addEventRow('badRating')" class="text-xs bg-yellow-100 text-yellow-600 px-2 py-1 rounded hover:bg-yellow-200"><i class="fas fa-plus"></i> 新增</button>
                        </div>
                        <div id="badRatingList" class="space-y-2 text-sm">
                            <!-- JS 動態插入 -->
                        </div>
                    </div>
                </div>

                <!-- 按鈕 -->
                <button onclick="calculate()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition">
                    <i class="fas fa-calculator mr-2"></i> 開始精算
                </button>
            </div>

            <!-- 右側結果區 (佔 8/12) -->
            <div class="xl:col-span-8 space-y-6">
                
                <!-- 結果摘要 -->
                <div class="bg-white rounded-xl shadow p-6 border-t-4 border-green-500">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h3 class="font-bold text-gray-800">月退休金試算</h3>
                        <button onclick="toggleModal(true)" class="text-xs text-blue-500 hover:text-blue-700"><i class="fas fa-question-circle"></i> 公式說明</button>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
                        <div class="p-3 bg-gray-50 rounded">
                            <div class="text-xs text-gray-500">退休年齡</div>
                            <div class="text-lg font-bold text-gray-800" id="resAge">--</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded">
                            <div class="text-xs text-gray-500">採計年資</div>
                            <div class="text-xl font-bold text-gray-800" id="resSeniority">--</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded">
                            <div class="text-xs text-gray-500">所得替代率</div>
                            <div class="text-xl font-bold text-blue-600" id="resRate">--</div>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded border border-yellow-100 relative">
                            <div class="text-xs text-yellow-700 font-bold">預估月退金</div>
                            <div class="text-xl font-bold text-yellow-600" id="resPension">--</div>
                            <div class="text-xs text-red-500 font-bold mt-1" id="resPensionNote"></div>
                        </div>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 border-b pb-2 mb-4 mt-6">公保養老給付 (一次領)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="p-3 bg-indigo-50 rounded">
                            <div class="text-xs text-indigo-700">公保年資 (滿42個基數上限)</div>
                            <div class="text-lg font-bold text-indigo-800" id="resInsYears">--</div>
                        </div>
                        <div class="p-3 bg-indigo-50 rounded">
                            <div class="text-xs text-indigo-700">給付基數 (1.2/年)</div>
                            <div class="text-lg font-bold text-indigo-800" id="resInsUnits">--</div>
                        </div>
                        <div class="p-3 bg-indigo-100 rounded border border-indigo-200">
                            <div class="text-xs text-indigo-800 font-bold">公保給付金額</div>
                            <div class="text-xl font-bold text-indigo-700" id="resInsAmount">--</div>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-between items-end border-t pt-4">
                        <div>
                            <span class="text-sm text-gray-600">最後 15 年平均本俸：</span>
                            <span class="font-bold text-lg text-gray-800" id="resAvgSalary">--</span>
                        </div>
                        <div class="text-xs text-gray-400 text-right">
                            *此試算僅供參考，實際金額以銓敘部及台銀公保部審定為準
                        </div>
                    </div>
                </div>

                <!-- 詳細表格 -->
                <div class="bg-white rounded-xl shadow overflow-hidden flex flex-col h-[600px]">
                    <div class="p-3 bg-gray-100 border-b flex justify-between items-center text-sm">
                        <span class="font-bold text-gray-700">生涯歷程明細表 (學年度制)</span>
                        <div class="flex gap-2 text-xs">
                            <span class="flex items-center"><span class="w-2 h-2 bg-red-100 border border-red-300 mr-1"></span>留職停薪</span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-yellow-100 border border-yellow-300 mr-1"></span>未晉級</span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-blue-100 border border-blue-300 mr-1"></span>均俸計算區間</span>
                        </div>
                    </div>
                    <div class="table-container flex-grow">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead>
                                <tr class="text-gray-600 border-b">
                                    <th class="p-3 text-center bg-gray-50">學年度</th>
                                    <th class="p-3 text-center bg-gray-50">期間</th>
                                    <th class="p-3 text-center bg-gray-50">年齡</th>
                                    <th class="p-3 text-center bg-gray-50">薪級</th>
                                    <th class="p-3 text-center bg-gray-50">薪點</th>
                                    <th class="p-3 text-right bg-gray-50">本俸</th>
                                    <th class="p-3 bg-gray-50 w-1/4">狀態/備註</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody" class="divide-y divide-gray-100">
                                <!-- JS Render -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-sm text-gray-500 pb-8">
            <p>資料來源為 114.1.1 教師薪資表與 114.11.30 前的計算公式</p>
        </div>
    </div>

    <!-- 說明視窗 Modal -->
    <div id="infoModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl modal-content animate-fade-in transform scale-100 transition-transform">
            <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-book-open text-blue-600 mr-2"></i>退休金計算公式說明</h3>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                
                <!-- 1. 月退休金 -->
                <div>
                    <h4 class="text-md font-bold text-yellow-700 border-l-4 border-yellow-500 pl-2 mb-2">一、月退休金 (Monthly Pension)</h4>
                    <div class="bg-yellow-50 p-4 rounded-lg text-sm text-gray-700 space-y-2">
                        <p><span class="font-bold">基本計算：</span> <span class="text-blue-700 font-mono text-base">最後15年平均本俸 × 2 × 所得替代率</span></p>
                        <ul class="list-disc list-inside space-y-1 ml-2 text-gray-600">
                            <li><strong>起支年齡：</strong> 原則上需年滿 58 歲。</li>
                            <li><strong>平均本俸：</strong> 取退休前最後在職的 15 年本俸進行平均。</li>
                            <li><strong>所得替代率：</strong> 任職滿 15 年為 30%，第 16-35 年每年 +1.5%，第 36-40 年每年 +0.5% (最高 62.5%)。</li>
                        </ul>
                    </div>
                    
                    <!-- 提早退休說明 -->
                    <h5 class="text-sm font-bold text-gray-700 mt-3 mb-1">若未滿 58 歲 (但在 53 歲以上) 之選項：</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        <div class="bg-white border p-2 rounded">
                            <span class="block font-bold text-blue-600">1. 展期月退休金</span>
                            <span class="text-gray-500">現在退休，但等到 58 歲才開始領錢。</span>
                            <span class="block mt-1 text-xs bg-gray-100 p-1">金額 = 全額月退休金</span>
                        </div>
                        <div class="bg-white border p-2 rounded">
                            <span class="block font-bold text-red-600">2. 減額月退休金</span>
                            <span class="text-gray-500">現在退休，現在開始領錢，但金額打折。</span>
                            <span class="block mt-1 text-xs bg-gray-100 p-1">金額 = 全額 × (1 - 提前年數×4%)</span>
                            <span class="block text-xs text-gray-400">最多提前5年(扣20%)</span>
                        </div>
                    </div>
                </div>

                <!-- 2. 公保養老給付 -->
                <div>
                    <h4 class="text-md font-bold text-indigo-700 border-l-4 border-indigo-500 pl-2 mb-2">二、公保養老給付 (一次給付)</h4>
                    <div class="bg-indigo-50 p-4 rounded-lg text-sm text-gray-700 space-y-2">
                        <p><span class="font-bold">計算公式：</span> <span class="text-blue-700 font-mono text-base">退休時本俸 × 給付基數</span></p>
                        <ul class="list-disc list-inside space-y-1 ml-2 text-gray-600">
                            <li><strong>計算薪資：</strong> 以退休當月的本俸為準。</li>
                            <li><strong>給付基數 (最高42)：</strong>
                                <ul class="list-disc list-inside ml-6 mt-1 text-xs">
                                    <li>每滿 1 年給予 1.2 個基數 (即每個月 0.1 個基數)。</li>
                                    <li>年資未滿 1 個月之畸零日數，以 1 個月計算。</li>
                                    <li>基數上限為 42 個基數 (即 35 年)。</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="text-xs text-gray-400 text-center border-t pt-4">
                    * 本系統僅依據一般公式進行估算，實際核發金額可能受法規細節、過渡期條款等影響，請以主管機關審定為準。
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                <button onclick="toggleModal(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- 隱藏的模板 -->
    <template id="tmpl-reeval">
        <div class="flex flex-col gap-1 bg-blue-50 p-2 rounded border border-blue-200 animate-fade-in row-item mb-1">
            <div class="flex gap-2 items-center">
                <span class="text-xs text-gray-500">日期</span>
                <input type="text" placeholder="民國YYY/MM/DD" class="w-28 text-xs p-1 border rounded reeval-date">
                <span class="text-xs text-gray-500">提</span>
                <input type="number" placeholder="級數" value="0" class="w-12 text-xs p-1 border rounded reeval-jump">
                <span class="text-xs text-gray-500">級</span>
            </div>
            <div class="flex gap-2 items-center">
                <span class="text-xs text-gray-500">變更最高俸級</span>
                <select class="text-xs p-1 border rounded w-32 reeval-new-degree">
                    <option value="none">不變更 (維持原頂)</option>
                    <option value="master">變更為碩士頂 (650)</option>
                    <option value="phd">變更為博士頂 (680)</option>
                </select>
                <button class="ml-auto text-red-400 hover:text-red-600" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </template>

    <template id="tmpl-leave">
        <div class="flex flex-col gap-1 bg-red-50 p-2 rounded border border-red-100 animate-fade-in row-item mb-1">
            <div class="flex gap-2 items-center">
                <span class="text-xs text-red-700">起</span>
                <input type="text" placeholder="民國YYY/MM/DD" class="w-28 text-xs p-1 border rounded leave-start">
            </div>
            <div class="flex gap-2 items-center">
                <span class="text-xs text-red-700">迄</span>
                <input type="text" placeholder="民國YYY/MM/DD" class="w-28 text-xs p-1 border rounded leave-end">
                <button class="ml-auto text-red-400 hover:text-red-600" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </template>

    <template id="tmpl-badRating">
        <div class="flex gap-2 items-center bg-yellow-50 p-2 rounded border border-yellow-100 animate-fade-in row-item mb-1">
            <span class="text-xs">學年度</span>
            <input type="number" placeholder="如 112" class="w-20 text-xs p-1 border rounded rating-year">
            <span class="text-xs text-gray-500">考績丙(無)</span>
            <button class="ml-auto text-red-400 hover:text-red-600" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></button>
        </div>
    </template>

    <script>
        // --- 1. 資料庫與設定 ---
        const salaryData = {
            1: { point: 680, money: 57220 }, 2: { point: 650, money: 55690 }, 3: { point: 625, money: 54160 },
            4: { point: 600, money: 52630 }, 5: { point: 575, money: 51100 }, 6: { point: 550, money: 49560 },
            7: { point: 525, money: 48030 }, 8: { point: 500, money: 46500 }, 9: { point: 475, money: 44970 },
            10: { point: 450, money: 41900 }, 11: { point: 430, money: 40760 }, 12: { point: 410, money: 39610 },
            13: { point: 390, money: 38460 }, 14: { point: 370, money: 37310 }, 15: { point: 350, money: 36160 },
            16: { point: 330, money: 35010 }, 17: { point: 310, money: 33860 }, 18: { point: 290, money: 32710 },
            19: { point: 275, money: 31560 }, 20: { point: 260, money: 30410 }, 21: { point: 245, money: 29270 },
            22: { point: 230, money: 28120 }, 23: { point: 220, money: 27350 }, 24: { point: 210, money: 26580 },
            25: { point: 200, money: 25820 }, 26: { point: 190, money: 25050 }
        };

        const degreeConfig = {
            'bachelor': { start: 26, max: 625 },
            'master':   { start: 21, max: 650 },
            'phd':      { start: 16, max: 680 }
        };

        // --- 2. 輔助函數 ---

        function parseRocDate(year, month, day) {
            if(!year || !month || !day) return null;
            return new Date(parseInt(year) + 1911, parseInt(month) - 1, parseInt(day));
        }

        function parseRocString(str) {
            str = str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            }).trim();
            const parts = str.split(/[\/\-\.]/);
            if (parts.length < 3) return null;
            const y = parseInt(parts[0]);
            const m = parseInt(parts[1]);
            const d = parseInt(parts[2]);
            if (isNaN(y) || isNaN(m) || isNaN(d)) return null;
            return new Date(y + 1911, m - 1, d);
        }

        function toRocString(date) {
            if (!date) return "";
            return `${date.getFullYear() - 1911}/${date.getMonth() + 1}/${date.getDate()}`;
        }

        function formatMoney(num) {
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num);
        }

        function getAcademicYear(date) {
            const y = date.getFullYear() - 1911;
            const m = date.getMonth() + 1;
            return m >= 8 ? y : y - 1;
        }

        function getOverlapDays(start1, end1, start2, end2) {
            const s = start1 > start2 ? start1 : start2;
            const e = end1 < end2 ? end1 : end2;
            if (s > e) return 0;
            return Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + 1;
        }

        function getReplacementRate(years) {
            years = Math.floor(years); 
            if (years < 15) return 0;
            if (years >= 40) return 62.5;
            if (years <= 35) return 30 + (years - 15) * 1.5;
            return 60 + (years - 35) * 0.5;
        }

        // --- 3. UI 操作 ---

        function toggleModal(show) {
            const modal = document.getElementById('infoModal');
            if (show) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        function addEventRow(type) {
            const tmpl = document.getElementById(`tmpl-${type}`);
            const clone = tmpl.content.cloneNode(true);
            document.getElementById(`${type}List`).appendChild(clone);
        }

        function removeRow(btn) {
            btn.closest('.row-item').remove();
        }

        // --- 4. 核心計算邏輯 ---

        function calculate() {
            const deg = document.getElementById('degree').value;
            const birthDate = parseRocDate(document.getElementById('birthY').value, document.getElementById('birthM').value, document.getElementById('birthD').value);
            const startDate = parseRocDate(document.getElementById('startY').value, document.getElementById('startM').value, document.getElementById('startD').value);
            const retireDate = parseRocDate(document.getElementById('retireY').value, document.getElementById('retireM').value, document.getElementById('retireD').value);

            if (!birthDate || !startDate || !retireDate) {
                alert("請填寫完整的日期");
                return;
            }
            if (retireDate <= startDate) {
                alert("退休日期必須晚於初任日期");
                return;
            }

            // --- 提早退休介面控制 ---
            // 計算精確退休年齡 (以日為單位)
            const diffTime = retireDate - birthDate;
            const ageInYears = diffTime / (1000 * 60 * 60 * 24 * 365.25);
            const earlyRetireSection = document.getElementById('earlyRetireSection');
            const earlyRetireMsg = document.getElementById('earlyRetireMsg');
            let isEarly = false;
            let earlyYears = 0;
            let reductionRate = 0;

            if (ageInYears < 58) {
                isEarly = true;
                earlyRetireSection.classList.remove('hidden');
                
                earlyYears = 58 - ageInYears;
                
                // 檢查是否超過5年 (53歲以下)
                const reducedOption = document.querySelector('input[name="earlyOption"][value="reduced"]');
                const deferredOption = document.querySelector('input[name="earlyOption"][value="deferred"]');
                
                if (ageInYears < 53) {
                    reducedOption.disabled = true;
                    deferredOption.checked = true;
                    earlyRetireMsg.textContent = "※ 年齡未滿 53 歲，僅能選擇展期月退休金。";
                } else {
                    reducedOption.disabled = false;
                    earlyRetireMsg.textContent = `※ 目前約 ${ageInYears.toFixed(1)} 歲，提前約 ${earlyYears.toFixed(1)} 年。`;
                }

            } else {
                earlyRetireSection.classList.add('hidden');
            }

            // --- 資料處理 ---
            const reevals = [];
            let reevalError = false;
            document.querySelectorAll('#reevalList .row-item').forEach(row => {
                const dateStr = row.querySelector('.reeval-date').value;
                const date = parseRocString(dateStr);
                const jump = parseInt(row.querySelector('.reeval-jump').value) || 0;
                const newDeg = row.querySelector('.reeval-new-degree').value;
                
                if (dateStr && !date) reevalError = true; 
                if (date) reevals.push({ date, jump, newDeg });
            });
            if (reevalError) alert("部分改敘日期格式錯誤，請使用 112/08/01 格式");

            const leaves = [];
            let leaveError = false;
            document.querySelectorAll('#leaveList .row-item').forEach(row => {
                const sStr = row.querySelector('.leave-start').value;
                const eStr = row.querySelector('.leave-end').value;
                const s = parseRocString(sStr);
                const e = parseRocString(eStr);
                
                if ((sStr && !s) || (eStr && !e)) leaveError = true;
                if (s && e) leaves.push({ start: s, end: e });
            });
            if (leaveError) alert("部分留停日期格式錯誤，請使用 112/08/01 格式");

            const badRatings = []; 
            document.querySelectorAll('#badRatingList .row-item').forEach(row => {
                const y = parseInt(row.querySelector('.rating-year').value);
                if (y) badRatings.push(y);
            });

            // --- 迴圈模擬生涯 ---
            const startAY = getAcademicYear(startDate);
            const endAY = getAcademicYear(retireDate);

            let currentLevel = degreeConfig[deg].start;
            let maxPoint = degreeConfig[deg].max; 
            
            let history = [];
            let totalServiceDays = 0; 
            
            for (let ay = startAY; ay <= endAY; ay++) {
                const ayStart = new Date(ay + 1911, 7, 1);   
                const ayEnd = new Date(ay + 1911 + 1, 6, 31); 

                let effStart = ayStart < startDate ? startDate : ayStart;
                let effEnd = ayEnd > retireDate ? retireDate : ayEnd;

                if (effStart > effEnd) continue;

                const age = ay + 1911 - (birthDate.getFullYear());

                let reevalMsg = "";
                let jumpTotal = 0;
                let newMaxPoint = 0;
                
                reevals.forEach(r => {
                    if (r.date >= effStart && r.date <= effEnd) {
                        jumpTotal += r.jump;
                        if (r.newDeg !== 'none') {
                            newMaxPoint = degreeConfig[r.newDeg].max;
                            const degText = r.newDeg === 'master' ? '碩' : '博';
                            reevalMsg += `改${degText}頂 `;
                        }
                        if (r.jump > 0) reevalMsg += `提${r.jump}級 `;
                    }
                });
                
                if (newMaxPoint > 0) maxPoint = newMaxPoint; 
                if (jumpTotal > 0) {
                    currentLevel -= jumpTotal;
                    if (currentLevel < 1) currentLevel = 1;
                }

                let daysInYear = Math.ceil((effEnd - effStart) / (1000 * 60 * 60 * 24)) + 1;
                let leaveDays = 0;
                let isLeaving = false;

                leaves.forEach(l => {
                    const overlap = getOverlapDays(effStart, effEnd, l.start, l.end);
                    if (overlap > 0) {
                        leaveDays += overlap;
                        isLeaving = true;
                    }
                });

                let actualWorkDays = daysInYear - leaveDays;
                totalServiceDays += actualWorkDays;

                let canPromote = true;
                let statusTags = [];

                if (leaveDays > 0) {
                    canPromote = false;
                    statusTags.push({ text: "留停", color: "red" });
                }

                if (badRatings.includes(ay)) {
                    canPromote = false;
                    statusTags.push({ text: "考丙", color: "yellow" });
                }

                if (salaryData[currentLevel].point >= maxPoint) {
                    canPromote = false;
                    statusTags.push({ text: "頂", color: "gray" });
                }

                if (reevalMsg) statusTags.push({ text: reevalMsg.trim(), color: "blue" });

                const salary = salaryData[currentLevel];
                history.push({
                    ay: ay,
                    dateRange: `${ayStart.getFullYear()-1911}/${ayStart.getMonth()+1} ~ ${ayEnd.getFullYear()-1911}/${ayEnd.getMonth()+1}`,
                    age: age,
                    level: currentLevel,
                    point: salary.point,
                    money: salary.money,
                    status: statusTags,
                    isLeave: (actualWorkDays <= 0), 
                    actualWorkDays: actualWorkDays
                });

                if (ay < endAY && canPromote && currentLevel > 1) {
                    let nextLevel = currentLevel - 1;
                    if (salaryData[nextLevel].point <= maxPoint) {
                        currentLevel--;
                    }
                }
            }

            // --- 退休金計算 ---
            const validSeniorityYears = totalServiceDays / 365.0; 
            const senY = Math.floor(validSeniorityYears);
            const senM = Math.floor((totalServiceDays % 365) / 30);
            
            const replaceRate = getReplacementRate(validSeniorityYears);

            // 均俸
            let daysCounted = 0;
            let totalWeightedSalary = 0;
            const targetDays = 15 * 365;
            let avgRangeIndices = [];

            for (let i = history.length - 1; i >= 0; i--) {
                const h = history[i];
                if (h.actualWorkDays <= 0) continue; 

                let daysToTake = h.actualWorkDays;
                if (daysCounted + daysToTake > targetDays) {
                    daysToTake = targetDays - daysCounted;
                }

                totalWeightedSalary += h.money * daysToTake;
                daysCounted += daysToTake;
                avgRangeIndices.push(i);

                if (daysCounted >= targetDays) break;
            }

            const avgSalary = daysCounted > 0 ? Math.round(totalWeightedSalary / daysCounted) : 0;
            
            // 基礎月退
            let monthlyPension = 0;
            if (validSeniorityYears >= 15) {
                monthlyPension = Math.round(avgSalary * 2 * (replaceRate / 100));
            }

            // --- 處理減額/展期 ---
            let finalPension = monthlyPension;
            let pensionNote = "";
            
            if (isEarly && validSeniorityYears >= 15) {
                const option = document.querySelector('input[name="earlyOption"]:checked').value;
                if (option === 'reduced') {
                    // 減額：每早1年扣4%
                    // 用無條件進位的年數計算 (未滿1年以1年計) 還是精確計算? 
                    // 法規：提前一年減發百分之四。通常未滿一年會依比例或進位，此處採用簡單邏輯：
                    // 法規條文多為「每提前一年」，實務上未滿一年之畸零數按比例計算。
                    // 這裡為了保守估計，採用實際年數 * 4%
                    if (earlyYears > 5) earlyYears = 5; // 上限5年
                    const reducePercent = earlyYears * 0.04; 
                    finalPension = Math.round(monthlyPension * (1 - reducePercent));
                    pensionNote = `(已扣減 ${(reducePercent*100).toFixed(1)}% , 提前 ${earlyYears.toFixed(1)} 年)`;
                } else {
                    // 展期
                    pensionNote = "(須待年滿 58 歲起支領)";
                }
            }

            // 公保
            const insYears = Math.floor(totalServiceDays / 365);
            const insRemainingDays = totalServiceDays % 365;
            const insMonths = Math.ceil(insRemainingDays / 30); 
            const totalInsMonths = insYears * 12 + insMonths;
            let insUnits = totalInsMonths * 0.1;
            if (insUnits > 42) insUnits = 42;
            insUnits = Math.round(insUnits * 100) / 100; 
            const lastSalary = history.length > 0 ? history[history.length - 1].money : 0;
            const insAmount = Math.round(lastSalary * insUnits);

            if (history.length === 0) {
                alert("無有效任職期間，請檢查日期");
                return;
            }

            // 渲染結果
            let rAgeY = retireDate.getFullYear() - birthDate.getFullYear();
            let rAgeM = retireDate.getMonth() - birthDate.getMonth();
            let rAgeD = retireDate.getDate() - birthDate.getDate();
            if (rAgeD < 0) { rAgeM--; const prevMonth = new Date(retireDate.getFullYear(), retireDate.getMonth(), 0); rAgeD += prevMonth.getDate(); }
            if (rAgeM < 0) { rAgeY--; rAgeM += 12; }

            const elAge = document.getElementById('resAge');
            elAge.textContent = `${rAgeY}歲 ${rAgeM}月 ${rAgeD}日`;
            elAge.className = (rAgeY < 58) ? "text-lg font-bold text-red-600" : "text-lg font-bold text-gray-800";

            document.getElementById('resSeniority').textContent = `${senY}年 ${senM}月`;
            document.getElementById('resRate').textContent = `${replaceRate.toFixed(1)}%`;
            document.getElementById('resPension').textContent = formatMoney(finalPension);
            document.getElementById('resPensionNote').textContent = pensionNote;
            document.getElementById('resAvgSalary').textContent = formatMoney(avgSalary);
            
            document.getElementById('resInsYears').textContent = `${insYears}年 ${insMonths}月`;
            document.getElementById('resInsUnits').textContent = `${insUnits.toFixed(1)}`;
            document.getElementById('resInsAmount').textContent = formatMoney(insAmount);

            // 表格
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '';
            history.forEach((h, idx) => {
                let rowClass = "border-b hover:bg-gray-50";
                const isRetired = (idx === history.length - 1);
                const isInAvg = avgRangeIndices.includes(idx);
                const isLeave = h.status.some(s => s.text === "留停");
                const isFail = h.status.some(s => s.text === "考丙");

                if (isRetired) rowClass += " is-retired";
                else if (isLeave) rowClass += " is-leave";
                else if (isFail) rowClass += " is-promo-fail";
                else if (isInAvg) rowClass += " bg-blue-50";

                let tagsHtml = h.status.map(t => 
                    `<span class="tag-badge bg-${t.color}-100 text-${t.color}-700 border border-${t.color}-300">${t.text}</span>`
                ).join(" ");

                if (isInAvg && !isRetired && !isLeave) {
                    tagsHtml += ` <span class="tag-badge bg-blue-50 text-blue-600 border border-blue-200"><i class="fas fa-coins"></i> 均俸</span>`;
                }
                if (isRetired) tagsHtml += ` <span class="tag-badge bg-green-100 text-green-700">退休</span>`;

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-3 text-center">${h.ay} 學年</td>
                        <td class="p-3 text-center text-xs text-gray-500">${h.dateRange}</td>
                        <td class="p-3 text-center">${h.age}</td>
                        <td class="p-3 text-center">${h.level}</td>
                        <td class="p-3 text-center font-mono">${h.point}</td>
                        <td class="p-3 text-right font-mono font-medium">${formatMoney(h.money)}</td>
                        <td class="p-3 text-left flex gap-1 flex-wrap">${tagsHtml}</td>
                    </tr>
                `;
            });
        }
    </script>
</body>
</html>